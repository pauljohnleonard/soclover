<p *ngIf="loading">Loading...</p>

<svg
  *ngIf="!loading"
  xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink"
  width="800"
  height="600"
  transform-origin="0 0"
  [attr.transform]="transform"
  (mousemove)="mouseMove($event)"
  (mousedown)="mouseDown($event)"
  (mouseup)="mouseUp($event)"
  (mouseleave)="mouseLeave($event)"
  (click)="catchAllClick($event)"
>
  <defs>
    <!--  TOOLS -->
    <g fill="#000000" id="bin" style="cursor: pointer">
      <rect
        x="-7"
        y="-7"
        width="15"
        height="15"
        rx="2"
        fill="transparent"
      ></rect>

      <use
        xlink:href="assets/icons/delete.svg#delete"
        transform="scale(0.5) translate(-11,-11)"
      />
    </g>

    <g id="spin" style="cursor: pointer">
      <rect
        x="-7"
        y="-7"
        width="15"
        height="15"
        rx="2"
        fill="transparent"
      ></rect>
      <use
        xlink:href="assets/icons/rotate_right.svg#rotate_right"
        transform="scale(0.5) translate(-11,-11)"
      />
    </g>

    <!--  BUTTONS -->
    <g id="download">
      <use xlink:href="assets/icons/download.svg#download" />
    </g>

    <g id="thinking">
      <use xlink:href="assets/icons/cognition.svg#cognition" />
    </g>

    <g id="upload">
      <use xlink:href="assets/icons/upload.svg#upload" />
    </g>

    <g id="refresh" style="cursor: pointer">
      <use xlink:href="assets/icons/restart.svg#restart" />
    </g>

    <!-- PETAL -->
    <circle id="mycircle" [attr.cx]="cx" cy="0" [attr.r]="rad" fill="#390" />

    <g id="petal">
      <g [attr.transform]="'translate(0, ' + tweakY + ')'">
        <use xlink:href="#mycircle" />
      </g>
      <g [attr.transform]="'translate(0,  -' + tweakY + ')'">
        <use xlink:href="#mycircle" />
      </g>
    </g>

    <g [attr.transform]="petalTextTransform" id="textbox">
      <rect
        x="0"
        y="0"
        fill="#4A1"
        [attr.width]="petalTextWidth"
        [attr.height]="petalTextHeight"
        style="cursor: text"
        rx="5"
      />
    </g>

    <!-- CARDS -->
    <g id="card">
      <rect
        [attr.x]="cardPad"
        [attr.y]="cardPad"
        [attr.width]="cardWidth - cardPad"
        [attr.height]="cardWidth - cardPad"
        [attr.rx]="cardRad"
        fill="#fff"
        style="cursor: grab"
      />

      <rect
        [attr.x]="cardPad + holeBorder"
        [attr.y]="cardPad + holeBorder"
        [attr.width]="cardWidth - cardPad - holeBorder * 2"
        [attr.height]="cardWidth - cardPad - holeBorder * 2"
        [attr.rx]="cardRad"
        fill="#366e39"
        style="cursor: grab"
      />
    </g>

    <g id="dropZone">
      <rect
        [attr.x]="cardPad"
        [attr.y]="cardPad"
        [attr.width]="cardWidth - cardPad"
        [attr.height]="cardWidth - cardPad"
        [attr.rx]="cardRad"
        fill="#366e39"
      />
    </g>
  </defs>

  <g transform="translate(0,50)">
    <g [attr.transform]="'translate(120 120)'">
      <g transform="rotate(45)">
        <ng-container *ngFor="let petalData of petalDatas">
          <g [attr.transform]="petalData.rotate">
            <use xlink:href="#petal" />
            <use
              xlink:href="#textbox"
              [attr.stroke]="focusPetal === petalData.i ? 'black' : null"
              stroke-width="0.3"
              (click)="selectPetal(petalData.i, $event)"
            />
            <text
              [attr.x]="petalTextWidth / 2"
              [attr.y]="petalTextHeight / 2"
              [attr.transform]="petalData.transform"
              text-anchor="middle"
              dominant-baseline="middle"
              fill="black"
              [attr.font-size]="fontSize"
              font-family="Arial"
              font-weight="600"
            >
              {{ clues[petalData.i] }}
              <tspan
                class="blink-animation"
                *ngIf="focusPetal === petalData.i"
                fill="#fff"
              >
                &#9611;
              </tspan>
            </text>
          </g>
        </ng-container>

        <circle cx="0" cy="0" [attr.r]="rHub" fill="#390" />
      </g>
    </g>

    <g [attr.transform]="'translate(120 120)'">
      <ng-container *ngFor="let card of cards; let card_i = index">
        <g
          *ngIf="card.displaySlot !== undefined"
          [attr.transform]="
            card.displaySlot < 0
              ? 'translate(' + card.dragPos?.x + ',' + card.dragPos?.y + ')'
              : ''
          "
          (mousedown)="mouseDownCard($event, card)"
          (mouseup)="mouseUpCard($event, card)"
        >
          <g transform="rotate(45)">
            <g
              [attr.transform]="
                card.displaySlot >= 0
                  ? 'rotate(' + card.displaySlot * 90 + ')'
                  : ''
              "
            >
              <ng-container *ngIf="!card.dropZone">
                <use xlink:href="#card" />
              </ng-container>

              <use
                id="cardDropZone"
                *ngIf="card.dropZone"
                xlink:href="#dropZone"
              />

              <ng-container *ngFor="let word of card.words; let word_i = index">
                <g
                  [attr.transform]="
                    'rotate(' +
                    (word_i + card.orientation) * 90 +
                    ' ' +
                    (cardPad + cardWidth) / 2 +
                    ' ' +
                    (cardPad + cardWidth) / 2 +
                    ') translate(' +
                    (cardPad + cardWidth / 2) +
                    ',' +
                    wordNudgeIn +
                    ')'
                  "
                >
                  <text
                    x="0"
                    y="0"
                    [attr.transform]="
                      (word_i +
                        (card.displaySlot >= 0 ? card.displaySlot : 0) +
                        1 +
                        card.orientation) %
                        4 >
                      1
                        ? 'rotate( 180 0 -1)'
                        : ''
                    "
                    text-anchor="middle"
                    dominant-baseline="middle"
                    fill="black"
                    [attr.font-size]="fontSize"
                    font-family="Arial"
                    font-weight="600"
                  >
                    {{ card.words[word_i] }}
                  </text>
                </g>
              </ng-container>
            </g>
          </g>
        </g>
      </ng-container>

      <ng-container *ngFor="let tool of tools">
        <ng-container *ngIf="tool.card">
          <g transform="translate(-10,0)">
            <use
              xlink:href="#bin"
              [attr.x]="tool.binX"
              [attr.y]="tool.binY"
              (click)="toolClick(tool, 'bin')"
            />

            <use
              xlink:href="#spin"
              [attr.x]="tool.spinX"
              [attr.y]="tool.spinY"
              (click)="toolClick(tool, 'spin')"
            />
          </g>
        </ng-container>
      </ng-container>
    </g>
  </g>

  <g transform="translate(15,15)">
    <ng-container *ngFor="let button of buttons; let i = index">
      <g
        [attr.transform]="'translate(' + 40 * (i + 0.2) + ',0)'"
        style="cursor: pointer"
        (click)="buttonClick($event, button)"
      >
        <rect
          width="30"
          height="30"
          rx="11"
          fill="#fff"
          stroke="#000"
          stroke-width="0.5"
        />
        <use [attr.xlink:href]="'#' + button.id" x="3" y="3" />
        <text
          x="15"
          y="-5"
          text-anchor="middle"
          dominant-baseline="middle"
          fill="black"
          [attr.font-size]="fontSize"
          font-family="Arial"
          font-weight="600"
        >
          {{ button.text }}
        </text>
      </g>
    </ng-container>
  </g>
</svg>
